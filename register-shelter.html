<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Your Shelter - DonateBridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">üêæ DonateBridge</a>
        </div>
    </nav>

    <div class="container" style="padding-top: 100px; max-width: 800px;">
        <div class="card shadow-lg" style="border-radius: 20px;">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h3>Register Your Shelter</h3>
                    <p class="text-muted">Fill out the details below to add your organization to our platform.</p>
                </div>
                <div id="message-container"></div>
                <form id="register-form">
                    <div class="mb-3">
                        <label for="shelter-name" class="form-label">Shelter Name</label>
                        <input type="text" class="form-control" id="shelter-name" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="shelter-city" class="form-label">City</label>
                            <input type="text" class="form-control" id="shelter-city" required>
                        </div>
                        <div class="col-md-6">
                            <label for="shelter-state" class="form-label">State</label>
                            <input type="text" class="form-control" id="shelter-state" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="shelter-description" class="form-label">Short Description</label>
                        <textarea class="form-control" id="shelter-description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="shelter-image" class="form-label">Cover Image URL</label>
                        <input type="url" class="form-control" id="shelter-image" placeholder="https://images.unsplash.com/..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Animal Types (select all that apply)</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="dogs" id="type-dogs">
                            <label class="form-check-label" for="type-dogs">Dogs</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="cats" id="type-cats">
                            <label class="form-check-label" for="type-cats">Cats</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="wildlife" id="type-wildlife">
                            <label class="form-check-label" for="type-wildlife">Wildlife</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-custom w-100">Submit for Verification</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const SUPABASE_URL = 'https://lgrdixuixmjdsheyxsys.supabase.co'; // Replace
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxncmRpeHVpeG1qZHNoZXl4c3lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1Nzc4NTIsImV4cCI6MjA3MjE1Mzg1Mn0.2D16XP4T2yccB038m5GWkr_HzkTnsnbc2qcyrQ22Jk4'; // Replace
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const registerForm = document.getElementById('register-form');
        const messageContainer = document.getElementById('message-container');
        let currentUser = null;

        // Auth Guard: Check if user is logged in
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                // If not logged in, redirect them to the login page
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
        }

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get selected animal types
            const animalTypes = [];
            if (document.getElementById('type-dogs').checked) animalTypes.push('dogs');
            if (document.getElementById('type-cats').checked) animalTypes.push('cats');
            if (document.getElementById('type-wildlife').checked) animalTypes.push('wildlife');

            const shelterData = {
                name: document.getElementById('shelter-name').value,
                location_city: document.getElementById('shelter-city').value,
                location_state: document.getElementById('shelter-state').value,
                description: document.getElementById('shelter-description').value,
                image_url: document.getElementById('shelter-image').value,
                animal_types: animalTypes.join(' '), // e.g., "dogs cats"
                manager_user_id: currentUser.id // This is the automatic link!
            };

            const { data, error } = await supabase.from('shelters').insert([shelterData]);

            if (error) {
                messageContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            } else {
                messageContainer.innerHTML = `<div class="alert alert-success">Shelter registered successfully! Redirecting you to your dashboard...</div>`;
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        });

        // Run the auth check as soon as the page loads
        checkSession();
    </script>
</body>
</html>
